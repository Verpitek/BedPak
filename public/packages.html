<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>BedPak - Free Minecraft Bedrock Addon Repository | Download MCPE Addons</title>
        <link rel="icon" type="image/svg+xml" href="/logos/bedpak.svg" />

        <!-- Cloudflare Turnstile -->
        <script
            src="https://challenges.cloudflare.com/turnstile/v0/api.js"
            async
            defer
        ></script>

        <!-- SEO Meta Tags -->
        <meta
            name="description"
            content="BedPak is a free repository for Minecraft Bedrock Edition addons. Download, share, and discover .mcaddon files for MCPE, Windows, Xbox, and all Bedrock platforms."
        />
        <meta
            name="keywords"
            content="Minecraft Bedrock addons, MCPE addons, mcaddon download, Bedrock Edition addons, Minecraft PE addons, free Minecraft addons, Bedrock addon repository"
        />
        <meta name="author" content="BedPak" />
        <meta name="robots" content="index, follow" />
        <meta name="theme-color" content="#C4A574" />
        <link rel="canonical" href="https://bedpak.com/packages.html" />

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://bedpak.com/" />
        <meta
            property="og:title"
            content="BedPak - Free Minecraft Bedrock Addon Repository"
        />
        <meta
            property="og:description"
            content="Discover and download free Minecraft Bedrock Edition addons. A community-driven repository for .mcaddon files."
        />
        <meta
            property="og:image"
            content="https://bedpak.com/logos/bedpak.svg"
        />
        <meta property="og:site_name" content="BedPak" />
        <meta property="og:locale" content="en_US" />

        <!-- Twitter Card -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:url" content="https://bedpak.com/" />
        <meta
            name="twitter:title"
            content="BedPak - Free Minecraft Bedrock Addon Repository"
        />
        <meta
            name="twitter:description"
            content="Discover and download free Minecraft Bedrock Edition addons. A community-driven repository for .mcaddon files."
        />
        <meta
            name="twitter:image"
            content="https://bedpak.com/logos/bedpak.svg"
        />

        <!-- Additional SEO -->
        <meta name="application-name" content="BedPak" />
        <meta name="apple-mobile-web-app-title" content="BedPak" />
        <meta name="format-detection" content="telephone=no" />

        <!-- Structured Data - WebSite -->
        <script type="application/ld+json">
            {
                "@context": "https://schema.org",
                "@type": "WebSite",
                "name": "BedPak",
                "url": "https://bedpak.com",
                "description": "Free Minecraft Bedrock Edition addon repository. Download, share, and discover .mcaddon files for MCPE and Bedrock platforms.",
                "potentialAction": {
                    "@type": "SearchAction",
                    "target": "https://bedpak.com/packages.html?search={search_term_string}",
                    "query-input": "required name=search_term_string"
                }
            }
        </script>

        <!-- Structured Data - Organization -->
        <script type="application/ld+json">
            {
                "@context": "https://schema.org",
                "@type": "Organization",
                "name": "BedPak",
                "url": "https://bedpak.com",
                "logo": "https://bedpak.com/logos/bedpak.svg",
                "sameAs": ["https://discord.gg/fyNQNrr7dC"],
                "description": "Community-driven Minecraft Bedrock addon repository"
            }
        </script>

        <!-- Structured Data - SoftwareApplication -->
        <script type="application/ld+json">
            {
                "@context": "https://schema.org",
                "@type": "SoftwareApplication",
                "name": "BedPak",
                "applicationCategory": "GameApplication",
                "operatingSystem": "Windows, Android, iOS, Xbox",
                "offers": {
                    "@type": "Offer",
                    "price": "0",
                    "priceCurrency": "USD"
                },
                "description": "Repository for Minecraft Bedrock Edition addons (.mcaddon files)"
            }
        </script>
        <style>
            @font-face {
                font-family: "Monocraft";
                src: url("/fonts/Monocraft.woff2") format("woff2");
                font-weight: normal;
                font-style: normal;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family: inherit;
            }

            input,
            button,
            select,
            textarea {
                font-family:
                    "Monocraft",
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    Roboto,
                    Oxygen,
                    Ubuntu,
                    Cantarell,
                    sans-serif;
            }

            body {
                font-family:
                    "Monocraft",
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    Roboto,
                    Oxygen,
                    Ubuntu,
                    Cantarell,
                    sans-serif;
                background: #1a1a1a;
                color: #d0d0d0;
                min-height: 100vh;
                padding: 20px;
                position: relative;
                overflow-x: hidden;
            }

            body::before {
                content: "";
                position: fixed;
                inset: -100px;
                z-index: -1;
                background: repeating-linear-gradient(
                    -45deg,
                    #1a1a1a,
                    #1a1a1a 30px,
                    #0f0f0f 30px,
                    #0f0f0f 60px
                );
                background-size: 84.85px 84.85px;
                animation: stripe-move 20s linear infinite;
            }

            @keyframes stripe-move {
                from {
                    background-position: 0 0;
                }
                to {
                    background-position: 84.85px 84.85px;
                }
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                position: relative;
                z-index: 1;
            }

            .header {
                text-align: center;
                margin-bottom: 40px;
                padding: 30px 0;
                border-bottom: 1px solid #333;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .header-left {
                flex: 1;
                display: flex;
                align-items: center;
                gap: 20px;
            }

            .header-logo {
                width: 50px;
                height: 50px;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
            }

            .header-logo img {
                width: 100%;
                height: 100%;
                object-fit: contain;
            }

            .header h1 {
                font-size: 36px;
                margin-bottom: 10px;
                color: #fff;
            }

            .header p {
                color: #888;
                font-size: 14px;
            }

            .header-right {
                display: flex;
                align-items: center;
                gap: 15px;
            }

            .profile-btn {
                padding: 10px 20px;
                background: #c4a574;
                color: white;
                border: none;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: background 0.3s;
            }

            .profile-btn:hover {
                background: #b8925f;
            }

            .profile-user-info {
                display: flex;
                align-items: center;
                gap: 15px;
                color: #d0d0d0;
            }

            .profile-user-info span {
                font-size: 14px;
            }

            .logout-btn {
                padding: 8px 16px;
                background: #5a3a3a;
                color: #ffaaaa;
                border: 1px solid #7a5a5a;
                cursor: pointer;
                font-size: 14px;
                transition: background 0.3s;
            }

            .logout-btn:hover {
                background: #6a4a4a;
            }

            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.8);
                animation: fadeIn 0.3s;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            .modal-content {
                background: #222;
                margin: auto;
                padding: 40px;
                border: 1px solid #333;
                width: 90%;
                max-width: 600px;
                animation: slideDown 0.3s;
                max-height: 90vh;
                overflow-y: auto;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                position: fixed;
            }

            @keyframes slideDown {
                from {
                    transform: translateY(-50px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }

            .modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 30px;
            }

            .modal-header h2 {
                color: #fff;
                margin: 0;
            }

            .close-btn {
                background: none;
                border: none;
                color: #888;
                font-size: 28px;
                cursor: pointer;
                padding: 0;
                line-height: 1;
            }

            .close-btn:hover {
                color: #d0d0d0;
            }

            .form-group {
                margin-bottom: 20px;
            }

            .form-group label {
                display: block;
                margin-bottom: 8px;
                color: #d0d0d0;
                font-weight: 500;
            }

            .form-group input,
            .form-group select {
                width: 100%;
                padding: 12px;
                border: 1px solid #333;
                background: #1a1a1a;
                color: #d0d0d0;
                font-size: 14px;
                transition: border-color 0.3s;
            }

            .form-group input:focus,
            .form-group textarea:focus,
            .form-group select:focus {
                outline: none;
                border-color: #c4a574;
            }

            .form-textarea {
                width: 100%;
                padding: 12px;
                border: 1px solid #333;
                background: #1a1a1a;
                color: #d0d0d0;
                font-size: 14px;
                resize: vertical;
                font-family: inherit;
                transition: border-color 0.3s;
            }

            .form-btn {
                width: 100%;
                padding: 12px;
                background: #c4a574;
                color: white;
                border: none;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: background 0.3s;
            }

            .form-btn:hover {
                background: #b8925f;
            }

            .form-btn:disabled {
                background: #555;
                cursor: not-allowed;
            }

            .form-error {
                background: #3a2222;
                color: #ff8888;
                padding: 12px;
                border: 1px solid #5a3333;
                margin-bottom: 20px;
                display: none;
            }

            .form-success {
                background: #2a3a2a;
                color: #88ff88;
                padding: 12px;
                border: 1px solid #4a6a4a;
                margin-bottom: 20px;
                display: none;
            }

            .tab-buttons {
                display: flex;
                gap: 10px;
                margin-bottom: 30px;
                border-bottom: 1px solid #333;
            }

            .tab-btn {
                flex: 1;
                padding: 12px;
                background: none;
                border: none;
                color: #888;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                border-bottom: 2px solid transparent;
                transition: all 0.3s;
            }

            .tab-btn.active {
                color: #c4a574;
                border-bottom-color: #c4a574;
            }

            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
            }

            .password-help {
                font-size: 12px;
                color: #888;
                margin-top: 8px;
                line-height: 1.4;
            }

            .controls {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr 1fr;
                gap: 15px;
                margin-bottom: 30px;
                padding: 20px;
                background: #222;
                border: 1px solid #333;
            }

            .control-group {
                display: flex;
                flex-direction: column;
            }

            .control-group label {
                font-size: 12px;
                color: #888;
                margin-bottom: 8px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .control-group input,
            .control-group select {
                padding: 10px 12px;
                background: #1a1a1a;
                border: 1px solid #333;
                color: #d0d0d0;
                font-size: 14px;
                transition: border-color 0.3s;
            }

            .control-group input:focus,
            .control-group select:focus {
                outline: none;
                border-color: #c4a574;
            }

            .control-group input::placeholder {
                color: #555;
            }

            .packages-info {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                padding: 0 5px;
            }

            .packages-count {
                font-size: 14px;
                color: #888;
            }

            .sort-options {
                display: flex;
                gap: 10px;
            }

            .sort-btn {
                padding: 8px 16px;
                background: #222;
                border: 1px solid #333;
                color: #d0d0d0;
                cursor: pointer;
                font-size: 12px;
                transition: all 0.3s;
            }

            .sort-btn:hover,
            .sort-btn.active {
                background: #c4a574;
                border-color: #c4a574;
                color: #fff;
            }

            .packages-list {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
                margin-bottom: 40px;
            }

            .package-card {
                background: #222;
                padding: 20px;
                border: 1px solid #333;
                transition: all 0.3s;
                display: flex;
                flex-direction: column;
            }

            .package-card:hover {
                background: #262626;
                border-color: #c4a574;
            }

            .package-icon {
                width: 100%;
                height: 150px;
                background: #1a1a1a;
                border: 1px solid #333;
                margin-bottom: 15px;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: hidden;
            }

            .package-icon img {
                max-width: 100%;
                max-height: 100%;
                object-fit: contain;
            }

            .package-icon.placeholder {
                color: #555;
                font-size: 48px;
            }

            .package-card h3 {
                color: #fff;
                margin-bottom: 10px;
                font-size: 18px;
                word-break: break-word;
            }

            .package-meta {
                display: flex;
                gap: 15px;
                margin-bottom: 15px;
                font-size: 12px;
                color: #888;
            }

            .package-meta span {
                display: flex;
                align-items: center;
                gap: 5px;
            }

            .package-description {
                color: #aaa;
                font-size: 14px;
                margin-bottom: 15px;
                flex-grow: 1;
                line-height: 1.5;
            }

            .package-author {
                color: #c4a574;
                font-size: 13px;
                margin-bottom: 15px;
            }

            .package-version {
                background: #1a1a1a;
                color: #888;
                padding: 6px 10px;
                font-size: 12px;
                margin-bottom: 15px;
                display: inline-block;
                border: 1px solid #333;
            }

            .download-btn {
                padding: 10px 16px;
                background: #c4a574;
                color: white;
                border: none;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: background 0.3s;
                text-align: center;
                text-decoration: none;
                display: block;
            }

            .download-btn:hover {
                background: #b8925f;
            }

            .package-actions {
                display: flex;
                gap: 10px;
                margin-top: 10px;
            }

            .package-actions .download-btn {
                flex: 1;
            }

            .edit-btn {
                padding: 10px 16px;
                background: #4a6fa5;
                color: white;
                border: none;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: background 0.3s;
                text-align: center;
            }

            .edit-btn:hover {
                background: #3d5d8a;
            }

            .delete-btn {
                padding: 10px 16px;
                background: #8b3a3a;
                color: white;
                border: none;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: background 0.3s;
                text-align: center;
            }

            .delete-btn:hover {
                background: #a04545;
            }

            .kofi-btn {
                padding: 10px 16px;
                background: #ff5e5b;
                color: white;
                border: none;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: background 0.3s;
                text-align: center;
                text-decoration: none;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
            }

            .kofi-btn:hover {
                background: #e54542;
            }

            .kofi-btn svg {
                width: 16px;
                height: 16px;
                fill: currentColor;
            }

            /* Support Popup Modal Styles */
            .support-popup {
                display: none;
                position: fixed;
                z-index: 2000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.85);
                animation: fadeIn 0.3s;
            }

            .support-popup-content {
                background: #222;
                margin: auto;
                padding: 40px;
                border: 1px solid #333;
                width: 90%;
                max-width: 450px;
                text-align: center;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                animation: popIn 0.3s ease-out;
            }

            @keyframes popIn {
                from {
                    transform: translate(-50%, -50%) scale(0.8);
                    opacity: 0;
                }
                to {
                    transform: translate(-50%, -50%) scale(1);
                    opacity: 1;
                }
            }

            .support-popup-header {
                margin-bottom: 20px;
            }

            .support-popup-header h3 {
                color: #fff;
                font-size: 22px;
                margin-bottom: 10px;
            }

            .support-popup-header p {
                color: #aaa;
                font-size: 14px;
                line-height: 1.5;
            }

            .support-popup-author {
                color: #c4a574;
                font-weight: 600;
            }

            .support-popup-buttons {
                display: flex;
                flex-direction: column;
                gap: 12px;
                margin-top: 25px;
            }

            .support-popup-kofi {
                padding: 14px 24px;
                background: #ff5e5b;
                color: white;
                border: none;
                cursor: pointer;
                font-size: 16px;
                font-weight: 600;
                transition:
                    background 0.3s,
                    transform 0.2s;
                text-decoration: none;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
            }

            .support-popup-kofi:hover {
                background: #e54542;
                transform: scale(1.02);
            }

            .support-popup-kofi svg {
                width: 20px;
                height: 20px;
                fill: currentColor;
            }

            .support-popup-skip {
                padding: 12px 24px;
                background: transparent;
                color: #888;
                border: 1px solid #444;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.3s;
            }

            .support-popup-skip:hover {
                background: #333;
                color: #d0d0d0;
                border-color: #555;
            }

            .support-popup-skip:disabled {
                cursor: not-allowed;
                opacity: 0.6;
            }

            .support-popup-timer {
                display: inline-block;
                min-width: 20px;
            }

            .checkbox-group {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 15px;
            }

            .checkbox-group input[type="checkbox"] {
                width: 18px;
                height: 18px;
                cursor: pointer;
            }

            .checkbox-group label {
                cursor: pointer;
                color: #d0d0d0;
                font-size: 14px;
            }

            .current-icon-preview {
                margin-bottom: 15px;
                padding: 15px;
                background: #1a1a1a;
                border: 1px solid #333;
            }

            .current-icon-preview img {
                max-width: 80px;
                max-height: 80px;
                border: 1px solid #444;
            }

            .current-icon-preview p {
                font-size: 12px;
                color: #888;
                margin-bottom: 8px;
            }

            .danger-zone {
                margin-top: 20px;
                padding: 15px;
                border: 1px solid #5a3333;
                background: #2a1a1a;
            }

            .danger-zone h4 {
                color: #ff8888;
                margin-bottom: 10px;
                font-size: 14px;
            }

            .danger-zone p {
                font-size: 12px;
                color: #888;
                margin-bottom: 10px;
            }

            .empty-state {
                text-align: center;
                padding: 60px 20px;
                color: #888;
                grid-column: 1/-1;
            }

            .empty-state p {
                font-size: 16px;
                margin-bottom: 10px;
            }

            .loading {
                text-align: center;
                padding: 40px 20px;
                grid-column: 1/-1;
            }

            .spinner {
                border: 3px solid #333;
                border-top: 3px solid #4a6fa5;
                width: 40px;
                height: 40px;
                animation: spin 1s linear infinite;
                margin: 0 auto;
            }

            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }

            .pagination {
                display: flex;
                justify-content: center;
                gap: 8px;
                margin-top: 40px;
                padding: 20px 0;
                flex-wrap: wrap;
            }

            .pagination button,
            .pagination span {
                padding: 8px 12px;
                background: #222;
                border: 1px solid #333;
                color: #d0d0d0;
                cursor: pointer;
                font-size: 12px;
                transition: all 0.3s;
            }

            .pagination button:hover:not(:disabled) {
                background: #c4a574;
                border-color: #c4a574;
            }

            .pagination button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .pagination .active {
                background: #c4a574;
                border-color: #c4a574;
                color: #fff;
            }

            .error {
                background: #3a2222;
                border: 1px solid #5a3333;
                color: #ff8888;
                padding: 15px;
                text-align: center;
                margin-bottom: 20px;
            }

            .upload-btn {
                padding: 10px 20px;
                background: #4a6fa5;
                color: white;
                border: none;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: background 0.3s;
            }

            .upload-btn:hover {
                background: #3d5d8a;
            }

            .file-input-wrapper {
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .file-select-btn {
                padding: 10px 16px;
                background: #333;
                color: #d0d0d0;
                border: 1px solid #444;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.3s;
                white-space: nowrap;
            }

            .file-select-btn:hover {
                background: #444;
                border-color: #555;
            }

            .selected-file-name {
                color: #888;
                font-size: 13px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                flex: 1;
            }

            .selected-file-name.has-file {
                color: #88cc88;
            }

            .upload-progress {
                margin-bottom: 20px;
            }

            .progress-bar {
                width: 100%;
                height: 8px;
                background: #333;
                overflow: hidden;
                margin-bottom: 8px;
            }

            .progress-fill {
                height: 100%;
                background: #4a6fa5;
                width: 0%;
                transition: width 0.3s;
            }

            #progressText {
                font-size: 12px;
                color: #888;
            }

            @media (max-width: 768px) {
                body {
                    padding: 10px;
                }

                .container {
                    margin: 0;
                }

                .header {
                    flex-direction: column;
                    gap: 15px;
                    padding: 15px 0;
                }

                .header h1 {
                    font-size: 24px;
                }

                .header p {
                    font-size: 12px;
                }

                .header-right {
                    width: 100%;
                    gap: 10px;
                }

                .profile-btn {
                    flex: 1;
                    padding: 8px 12px;
                    font-size: 12px;
                }

                .controls {
                    grid-template-columns: 1fr;
                    gap: 12px;
                    padding: 15px;
                }

                .control-group label {
                    font-size: 11px;
                }

                .control-group input,
                .control-group select {
                    padding: 8px 10px;
                    font-size: 13px;
                }

                .packages-info {
                    flex-direction: column;
                    gap: 10px;
                    align-items: flex-start;
                }

                .packages-count {
                    font-size: 12px;
                }

                .sort-options {
                    width: 100%;
                    flex-wrap: wrap;
                    gap: 8px;
                }

                .sort-btn {
                    flex: 1;
                    min-width: 80px;
                    padding: 6px 12px;
                    font-size: 11px;
                }

                .packages-list {
                    grid-template-columns: 1fr;
                    gap: 15px;
                }

                .package-card {
                    padding: 15px;
                }

                .package-icon {
                    height: 120px;
                    margin-bottom: 12px;
                }

                .package-card h3 {
                    font-size: 16px;
                    margin-bottom: 8px;
                }

                .package-meta {
                    gap: 10px;
                    font-size: 11px;
                    margin-bottom: 10px;
                }

                .package-description {
                    font-size: 13px;
                    margin-bottom: 10px;
                }

                .package-author {
                    font-size: 12px;
                    margin-bottom: 10px;
                }

                .package-version {
                    font-size: 11px;
                    padding: 5px 8px;
                }

                .download-btn {
                    padding: 8px 12px;
                    font-size: 13px;
                }

                .package-actions {
                    flex-direction: column;
                }

                .edit-btn,
                .delete-btn {
                    padding: 8px 12px;
                    font-size: 13px;
                }

                .pagination {
                    gap: 6px;
                    padding: 15px 0;
                }

                .pagination button,
                .pagination span {
                    padding: 6px 10px;
                    font-size: 11px;
                }

                .modal-content {
                    width: 90%;
                    max-width: 90%;
                    padding: 20px;
                    margin: auto !important;
                    top: 50% !important;
                    left: 50% !important;
                    transform: translate(-50%, -50%) !important;
                    max-height: 85vh;
                }

                .modal-header h2 {
                    font-size: 18px;
                }

                .form-group input,
                .form-group textarea {
                    font-size: 14px;
                    padding: 10px;
                }

                .form-btn {
                    padding: 10px;
                    font-size: 14px;
                }

                .tab-btn {
                    padding: 10px;
                    font-size: 13px;
                }

                .profile-user-info {
                    font-size: 13px;
                }

                .upload-btn {
                    padding: 8px 12px;
                    font-size: 12px;
                }

                .support-popup-content {
                    width: 95%;
                    padding: 25px 20px;
                }

                .support-popup-header h3 {
                    font-size: 18px;
                }

                .support-popup-header p {
                    font-size: 13px;
                }

                .support-popup-kofi {
                    padding: 12px 20px;
                    font-size: 14px;
                }

                .support-popup-skip {
                    padding: 10px 20px;
                    font-size: 13px;
                }

                .file-input-wrapper {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 8px;
                }

                .file-select-btn {
                    width: 100%;
                    text-align: center;
                }

                .selected-file-name {
                    width: 100%;
                }

                #uploadDescription {
                    font-size: 13px;
                }
            }

            .view-details-btn {
                padding: 8px 14px;
                background: #333;
                color: #d0d0d0;
                border: 1px solid #444;
                cursor: pointer;
                font-size: 13px;
                transition: all 0.3s;
                text-decoration: none;
                text-align: center;
            }

            .view-details-btn:hover {
                background: #444;
                border-color: #555;
            }

            /* Package card category */
            .package-category {
                display: inline-block;
                margin-bottom: 10px;
            }

            .package-category .category-badge {
                background: #1a1a1a;
                border: 1px solid #444;
                color: #c4a574;
                padding: 4px 10px;
                font-size: 11px;
                text-decoration: none;
                transition: all 0.3s;
                display: inline-block;
            }

            .package-category .category-badge:hover {
                background: #2a2a2a;
                border-color: #c4a574;
            }

            .footer {
                background: #222;
                border-top: 1px solid #333;
                padding: 30px 20px;
                text-align: center;
                color: #888;
                margin-top: 40px;
            }

            .footer-content {
                max-width: 1200px;
                margin: 0 auto;
            }

            .footer-links {
                display: flex;
                justify-content: center;
                gap: 30px;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }

            .footer-links a {
                color: #c4a574;
                text-decoration: none;
                font-size: 14px;
                transition: color 0.3s;
            }

            .footer-links a:hover {
                color: #d0b576;
            }

            .footer p {
                margin: 8px 0;
                font-size: 13px;
                color: #888;
            }

            .footer-divider {
                height: 1px;
                background: #333;
                margin: 15px 0;
            }

            @media (max-width: 768px) {
                .footer {
                    padding: 20px 15px;
                    margin-top: 30px;
                }

                .footer-links {
                    gap: 15px;
                    flex-direction: column;
                }

                .footer-links a {
                    font-size: 12px;
                }

                .footer p {
                    font-size: 12px;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header class="header" role="banner">
                <div class="header-left">
                    <div class="header-logo">
                        <img
                            src="/logos/bedpak.svg"
                            alt="BedPak - Minecraft Bedrock Addons Repository Logo"
                            width="50"
                            height="50"
                        />
                    </div>
                    <div style="text-align: left">
                        <h1>BedPak Repository</h1>
                        <p>Discover and download Minecraft Bedrock addons</p>
                    </div>
                </div>
                <nav
                    class="header-right"
                    id="headerRight"
                    aria-label="User navigation"
                >
                    <button class="profile-btn" onclick="openProfileModal()">
                        Profile
                    </button>
                </nav>
            </header>

            <main role="main" aria-label="Package browser">
                <section
                    class="controls"
                    aria-label="Search and filter controls"
                >
                    <div class="control-group">
                        <label for="search">Search Packages</label>
                        <input
                            type="search"
                            id="search"
                            placeholder="Search by name or description..."
                            aria-label="Search addons by name or description"
                        />
                    </div>
                    <div class="control-group">
                        <label for="author">Filter by Author</label>
                        <input
                            type="text"
                            id="author"
                            placeholder="Search author..."
                            aria-label="Filter addons by author name"
                        />
                    </div>
                    <div class="control-group">
                        <label for="categoryFilter">Filter by Category</label>
                        <select id="categoryFilter" aria-label="Filter addons by category">
                            <option value="">All Categories</option>
                            <optgroup label="Gameplay">
                                <option value="adventure">Adventure</option>
                                <option value="decoration">Decoration</option>
                                <option value="economy">Economy</option>
                                <option value="equipment">Equipment</option>
                                <option value="food">Food</option>
                                <option value="game-mechanics">Game Mechanics</option>
                                <option value="magic">Magic</option>
                                <option value="management">Management</option>
                                <option value="minigame">Minigame</option>
                                <option value="mobs">Mobs</option>
                                <option value="optimisation">Optimisation</option>
                                <option value="social">Social</option>
                                <option value="storage">Storage</option>
                                <option value="technology">Technology</option>
                                <option value="transportation">Transportation</option>
                                <option value="utility">Utility</option>
                                <option value="world-generation">World Generation</option>
                            </optgroup>
                            <optgroup label="Server">
                                <option value="administration">Administration</option>
                                <option value="anti-cheat">Anti-Cheat</option>
                                <option value="chat">Chat</option>
                                <option value="moderation">Moderation</option>
                                <option value="permissions">Permissions</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="sortBy">Sort By</label>
                        <select id="sortBy" aria-label="Sort packages">
                            <option value="newest">Newest</option>
                            <option value="oldest">Oldest</option>
                            <option value="downloads">Most Downloaded</option>
                            <option value="name">Name (A-Z)</option>
                        </select>
                    </div>
                </section>

                <div
                    id="messageContainer"
                    role="alert"
                    aria-live="polite"
                ></div>

                <div
                    class="packages-info"
                    aria-label="Package count and pagination options"
                >
                    <span class="packages-count" aria-live="polite">
                        Showing <strong id="displayCount">0</strong> of
                        <strong id="totalCount">0</strong> packages
                    </span>
                    <div
                        class="sort-options"
                        role="group"
                        aria-label="Items per page"
                    >
                        <button
                            class="sort-btn"
                            data-pagesize="12"
                            onclick="changePageSize(12)"
                            aria-label="Show 12 packages per page"
                        >
                            12 Per Page
                        </button>
                        <button
                            class="sort-btn active"
                            data-pagesize="20"
                            onclick="changePageSize(20)"
                            aria-pressed="true"
                            aria-label="Show 20 packages per page"
                        >
                            20 Per Page
                        </button>
                        <button
                            class="sort-btn"
                            data-pagesize="50"
                            onclick="changePageSize(50)"
                            aria-label="Show 50 packages per page"
                        >
                            50 Per Page
                        </button>
                    </div>
                </div>

                <section
                    id="packagesContainer"
                    class="packages-list"
                    aria-label="Minecraft Bedrock addons list"
                >
                    <div class="loading" aria-busy="true">
                        <div
                            class="spinner"
                            role="status"
                            aria-label="Loading packages"
                        ></div>
                    </div>
                </section>

                <nav
                    class="pagination"
                    id="pagination"
                    aria-label="Package list pagination"
                ></nav>
            </main>

            <footer class="footer" role="contentinfo">
                <div class="footer-content">
                    <nav class="footer-links" aria-label="Footer navigation">
                        <a href="/packages.html">Browse Addons</a>
                        <a href="/api-docs.html">API Documentation</a>
                        <a href="/terms-of-service.html">Terms of Service</a>
                        <a href="/privacy-policy.html">Privacy Policy</a>
                        <a
                            href="https://discord.gg/fyNQNrr7dC"
                            target="_blank"
                            rel="noopener noreferrer"
                            >Discord Community</a
                        >
                    </nav>
                    <div class="footer-divider"></div>
                    <p>&copy; 2025 BedPak. All rights reserved.</p>
                    <p>
                        BedPak is an independent service and is not affiliated
                        with Microsoft or Mojang Studios.
                    </p>
                    <p>Minecraft is a trademark of Mojang Studios.</p>
                </div>
            </footer>
        </div>

        <!-- Upload Modal -->
        <div id="uploadModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Upload Addon</h2>
                    <button class="close-btn" onclick="closeUploadModal()">
                        &times;
                    </button>
                </div>

                <div class="form-error" id="uploadError"></div>
                <div class="form-success" id="uploadSuccess"></div>

                <form
                    id="uploadForm"
                    onsubmit="
                        handleUpload(event);
                        return false;
                    "
                >
                    <div class="form-group">
                        <label for="uploadName">Package Name *</label>
                        <input
                            type="text"
                            id="uploadName"
                            placeholder="MyAwesomeAddon"
                            required
                            pattern="^[a-zA-Z0-9_-]{1,64}$"
                        />
                        <div class="password-help">
                            Only letters, numbers, underscores, and hyphens
                            (1-64 chars)
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="uploadDescription">Short Description</label>
                        <textarea
                            id="uploadDescription"
                            placeholder="Brief description for the package listing..."
                            rows="2"
                            class="form-textarea"
                            maxlength="500"
                        ></textarea>
                        <div class="password-help">
                            Shown in package cards. Max 500 characters.
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="uploadLongDescription"
                            >Full Description (Markdown)</label
                        >
                        <textarea
                            id="uploadLongDescription"
                            placeholder="# My Addon&#10;&#10;Detailed description with **markdown** support...&#10;&#10;## Features&#10;- Feature 1&#10;- Feature 2&#10;&#10;## Installation&#10;```&#10;Instructions here&#10;```"
                            rows="8"
                            class="form-textarea"
                        ></textarea>
                        <div class="password-help">
                            Supports Markdown formatting: headers, bold, lists,
                            code blocks, links, etc.
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="uploadVersion">Version</label>
                        <input
                            type="text"
                            id="uploadVersion"
                            placeholder="1.0.0"
                            pattern="^\d+\.\d+\.\d+$"
                        />
                        <div class="password-help">
                            Format: X.Y.Z (e.g., 1.0.0)
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="uploadIcon">Icon Image</label>
                        <div class="file-input-wrapper">
                            <input
                                type="file"
                                id="uploadIcon"
                                accept="image/png,image/jpeg,image/webp,image/gif,image/svg+xml,.svg"
                                style="display: none"
                            />
                            <button
                                type="button"
                                class="file-select-btn"
                                onclick="
                                    document
                                        .getElementById('uploadIcon')
                                        .click()
                                "
                            >
                                Choose Icon
                            </button>
                            <span
                                id="selectedIconName"
                                class="selected-file-name"
                                >No icon selected</span
                            >
                        </div>
                        <div class="password-help">
                            Optional. PNG, JPG, WebP, GIF, or SVG. Max 2MB.
                        </div>
                        <div
                            id="iconPreviewContainer"
                            style="display: none; margin-top: 10px"
                        >
                            <img
                                id="iconPreview"
                                style="
                                    max-width: 100px;
                                    max-height: 100px;
                                    border: 1px solid #333;
                                "
                            />
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="uploadCategory">Category</label>
                        <select id="uploadCategory" class="form-group input">
                            <option value="">Select a category...</option>
                            <optgroup label="Gameplay">
                                <option value="adventure">Adventure</option>
                                <option value="decoration">Decoration</option>
                                <option value="economy">Economy</option>
                                <option value="equipment">Equipment</option>
                                <option value="food">Food</option>
                                <option value="game-mechanics">Game Mechanics</option>
                                <option value="magic">Magic</option>
                                <option value="management">Management</option>
                                <option value="minigame">Minigame</option>
                                <option value="mobs">Mobs</option>
                                <option value="optimisation">Optimisation</option>
                                <option value="social">Social</option>
                                <option value="storage">Storage</option>
                                <option value="technology">Technology</option>
                                <option value="transportation">Transportation</option>
                                <option value="utility">Utility</option>
                                <option value="world-generation">World Generation</option>
                            </optgroup>
                            <optgroup label="Server">
                                <option value="administration">Administration</option>
                                <option value="anti-cheat">Anti-Cheat</option>
                                <option value="chat">Chat</option>
                                <option value="moderation">Moderation</option>
                                <option value="permissions">Permissions</option>
                            </optgroup>
                        </select>
                        <div class="password-help">
                            Choose a single category that best describes your addon
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="uploadYoutube"
                            >YouTube Video URL (optional)</label
                        >
                        <input
                            type="url"
                            id="uploadYoutube"
                            placeholder="https://youtube.com/watch?v=..."
                        />
                        <div class="password-help">
                            Showcase video for your addon
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="uploadKofiCheckbox" />
                            <label for="uploadKofiCheckbox"
                                >Add Ko-fi Support Link</label
                            >
                        </div>
                        <div id="uploadKofiGroup" style="display: none">
                            <label for="uploadKofiUrl">Ko-fi URL</label>
                            <input
                                type="url"
                                id="uploadKofiUrl"
                                placeholder="https://ko-fi.com/yourusername"
                            />
                            <div class="password-help">
                                Optional. Allow users to support you via Ko-fi.
                                Format: https://ko-fi.com/username
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="uploadFile">Addon File (.mcaddon) *</label>
                        <div class="file-input-wrapper">
                            <input
                                type="file"
                                id="uploadFile"
                                accept=".mcaddon"
                                required
                                style="display: none"
                            />
                            <button
                                type="button"
                                class="file-select-btn"
                                onclick="
                                    document
                                        .getElementById('uploadFile')
                                        .click()
                                "
                            >
                                Choose File
                            </button>
                            <span
                                id="selectedFileName"
                                class="selected-file-name"
                                >No file selected</span
                            >
                        </div>
                        <div class="password-help">
                            Maximum file size: 200MB. Only .mcaddon files are
                            accepted.
                        </div>
                    </div>
                    <div
                        id="uploadProgress"
                        class="upload-progress"
                        style="display: none"
                    >
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <span id="progressText">Uploading...</span>
                    </div>
                    <button type="submit" class="form-btn" id="uploadBtn">
                        Upload Addon
                    </button>
                </form>
            </div>
        </div>

        <!-- Profile Modal -->
        <div id="profileModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Profile</h2>
                    <button class="close-btn" onclick="closeProfileModal()">
                        &times;
                    </button>
                </div>

                <!-- Login/Register Tabs -->
                <div id="authContainer">
                    <div class="tab-buttons">
                        <button
                            class="tab-btn active"
                            data-tab="login"
                            onclick="switchTab('login')"
                        >
                            Login
                        </button>
                        <button
                            class="tab-btn"
                            data-tab="register"
                            onclick="switchTab('register')"
                        >
                            Register
                        </button>
                    </div>

                    <!-- Login Tab -->
                    <div id="login" class="tab-content active">
                        <div class="form-error" id="loginError"></div>
                        <form
                            onsubmit="
                                handleLogin(event);
                                return false;
                            "
                        >
                            <div class="form-group">
                                <label for="loginUsername">Username</label>
                                <input
                                    type="text"
                                    id="loginUsername"
                                    placeholder="Enter your username"
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <label for="loginPassword">Password</label>
                                <input
                                    type="password"
                                    id="loginPassword"
                                    placeholder="Enter your password"
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <div
                                    class="cf-turnstile"
                                    data-sitekey="0x4AAAAAACI85z04hVdplopt"
                                    data-theme="dark"
                                    data-callback="onLoginTurnstileSuccess"
                                    data-expired-callback="onLoginTurnstileExpired"
                                    id="loginTurnstile"
                                ></div>
                            </div>
                            <button
                                type="submit"
                                class="form-btn"
                                id="loginBtn"
                            >
                                Login
                            </button>
                        </form>
                    </div>

                    <!-- Register Tab -->
                    <div id="register" class="tab-content">
                        <div class="form-error" id="registerError"></div>
                        <div class="form-success" id="registerSuccess"></div>
                        <form
                            onsubmit="
                                handleRegister(event);
                                return false;
                            "
                        >
                            <div class="form-group">
                                <label for="registerUsername">Username</label>
                                <input
                                    type="text"
                                    id="registerUsername"
                                    placeholder="Choose a username"
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <label for="registerEmail">Email</label>
                                <input
                                    type="email"
                                    id="registerEmail"
                                    placeholder="Enter your email"
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <label for="registerPassword">Password</label>
                                <input
                                    type="password"
                                    id="registerPassword"
                                    placeholder="Enter your password"
                                    required
                                />
                                <div class="password-help">
                                     At least 8 characters<br />
                                     At least 1 number<br />
                                     At least 1 special character (!@#$%^&*
                                    etc.)
                                </div>
                            </div>
                            <div class="form-group">
                                <div
                                    class="cf-turnstile"
                                    data-sitekey="0x4AAAAAACI85z04hVdplopt"
                                    data-theme="dark"
                                    data-callback="onRegisterTurnstileSuccess"
                                    data-expired-callback="onRegisterTurnstileExpired"
                                    id="registerTurnstile"
                                ></div>
                            </div>
                            <button
                                type="submit"
                                class="form-btn"
                                id="registerBtn"
                            >
                                Register
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Profile Display (shown after login) -->
                <div id="profileContainer" style="display: none">
                    <div
                        class="profile-user-info"
                        style="
                            justify-content: space-between;
                            margin-bottom: 20px;
                        "
                    >
                        <div>
                            <p style="margin-bottom: 8px">Logged in as:</p>
                            <p
                                style="color: #4a6fa5; font-weight: 600"
                                id="loggedUsername"
                            ></p>
                        </div>
                    </div>
                    <button
                        class="form-btn logout-btn"
                        onclick="handleLogout()"
                        style="width: 100%; background: #5a3a3a"
                    >
                        Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- Support Popup Modal -->
        <div id="supportPopup" class="support-popup">
            <div class="support-popup-content">
                <div class="support-popup-header">
                    <h3>Support the Creator?</h3>
                    <p>
                        <span
                            class="support-popup-author"
                            id="supportAuthorName"
                        ></span>
                        made this addon. Consider supporting them if you enjoy
                        their work!
                    </p>
                </div>
                <div class="support-popup-buttons">
                    <a
                        id="supportKofiBtn"
                        href="#"
                        target="_blank"
                        rel="noopener noreferrer"
                        class="support-popup-kofi"
                    >
                        <svg
                            viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg"
                        >
                            <path
                                d="M23.881 8.948c-.773-4.085-4.859-4.593-4.859-4.593H.723c-.604 0-.679.798-.679.798s-.082 7.324-.022 11.822c.164 2.424 2.586 2.672 2.586 2.672s8.267-.023 11.966-.049c2.438-.426 2.683-2.566 2.658-3.734 4.352.24 7.422-2.831 6.649-6.916zm-11.062 3.511c-1.246 1.453-4.011 3.976-4.011 3.976s-.121.119-.31.023c-.076-.057-.108-.09-.108-.09-.443-.441-3.368-3.049-4.034-3.954-.709-.965-1.041-2.7-.091-3.71.951-1.01 3.005-1.086 4.363.407 0 0 1.565-1.782 3.468-.963 1.904.82 1.832 3.011.723 4.311z"
                            />
                        </svg>
                        Support on Ko-fi
                    </a>
                    <button
                        id="supportSkipBtn"
                        class="support-popup-skip"
                        disabled
                    >
                        No thanks, just download (<span
                            class="support-popup-timer"
                            id="supportTimer"
                            >3</span
                        >)
                    </button>
                </div>
            </div>
        </div>

        <!-- Edit Package Modal -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Package</h2>
                    <button class="close-btn" onclick="closeEditModal()">
                        &times;
                    </button>
                </div>

                <div class="form-error" id="editError"></div>
                <div class="form-success" id="editSuccess"></div>

                <form
                    id="editForm"
                    onsubmit="
                        handleUpdatePackage(event);
                        return false;
                    "
                >
                    <input type="hidden" id="editPackageId" />
                    <input type="hidden" id="editPackageOriginalName" />

                    <div class="form-group">
                        <label for="editName">Package Name *</label>
                        <input
                            type="text"
                            id="editName"
                            placeholder="MyAwesomeAddon"
                            required
                            pattern="^[a-zA-Z0-9_-]{1,64}$"
                        />
                        <div class="password-help">
                            Only letters, numbers, underscores, and hyphens
                            (1-64 chars)
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editDescription">Short Description</label>
                        <textarea
                            id="editDescription"
                            placeholder="Brief description for the package listing..."
                            rows="2"
                            class="form-textarea"
                            maxlength="500"
                        ></textarea>
                        <div class="password-help">
                            Shown in package cards. Max 500 characters.
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editLongDescription"
                            >Full Description (Markdown)</label
                        >
                        <textarea
                            id="editLongDescription"
                            placeholder="# My Addon&#10;&#10;Detailed description with **markdown** support..."
                            rows="8"
                            class="form-textarea"
                        ></textarea>
                        <div class="password-help">
                            Supports Markdown formatting: headers, bold, lists,
                            code blocks, links, etc.
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editVersion">Version</label>
                        <input
                            type="text"
                            id="editVersion"
                            placeholder="1.0.0"
                            pattern="^\d+\.\d+\.\d+$"
                        />
                        <div class="password-help">
                            Format: X.Y.Z (e.g., 1.0.0)
                        </div>
                    </div>

                    <!-- Current Icon Preview -->
                    <div
                        id="currentIconContainer"
                        class="current-icon-preview"
                        style="display: none"
                    >
                        <p>Current Icon:</p>
                        <img id="currentIconPreview" alt="Current icon" />
                    </div>

                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="updateIconCheckbox" />
                            <label for="updateIconCheckbox">Update Icon</label>
                        </div>
                        <div id="editIconGroup" style="display: none">
                            <label for="editIcon">New Icon Image</label>
                            <div class="file-input-wrapper">
                                <input
                                    type="file"
                                    id="editIcon"
                                    accept="image/png,image/jpeg,image/webp,image/gif,image/svg+xml,.svg"
                                    style="display: none"
                                />
                                <button
                                    type="button"
                                    class="file-select-btn"
                                    onclick="
                                        document
                                            .getElementById('editIcon')
                                            .click()
                                    "
                                >
                                    Choose Icon
                                </button>
                                <span
                                    id="editSelectedIconName"
                                    class="selected-file-name"
                                    >No icon selected</span
                                >
                            </div>
                            <div class="password-help">
                                PNG, JPG, WebP, GIF, or SVG. Max 2MB.
                            </div>
                            <div
                                id="editIconPreviewContainer"
                                style="display: none; margin-top: 10px"
                            >
                                <img
                                    id="editIconPreview"
                                    style="
                                        max-width: 100px;
                                        max-height: 100px;
                                        border: 1px solid #333;
                                    "
                                />
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="updateFileCheckbox" />
                            <label for="updateFileCheckbox"
                                >Update Addon File</label
                            >
                        </div>
                        <div id="editFileGroup" style="display: none">
                            <label for="editFile"
                                >New Addon File (.mcaddon)</label
                            >
                            <div class="file-input-wrapper">
                                <input
                                    type="file"
                                    id="editFile"
                                    accept=".mcaddon"
                                    style="display: none"
                                />
                                <button
                                    type="button"
                                    class="file-select-btn"
                                    onclick="
                                        document
                                            .getElementById('editFile')
                                            .click()
                                    "
                                >
                                    Choose File
                                </button>
                                <span
                                    id="editSelectedFileName"
                                    class="selected-file-name"
                                    >No file selected</span
                                >
                            </div>
                            <div class="password-help">
                            Maximum file size: 200MB. Only .mcaddon files are
                                accepted.
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="editCategory">Category</label>
                        <select id="editCategory" class="form-group input">
                            <option value="">Select a category...</option>
                            <optgroup label="Gameplay">
                                <option value="adventure">Adventure</option>
                                <option value="decoration">Decoration</option>
                                <option value="economy">Economy</option>
                                <option value="equipment">Equipment</option>
                                <option value="food">Food</option>
                                <option value="game-mechanics">Game Mechanics</option>
                                <option value="magic">Magic</option>
                                <option value="management">Management</option>
                                <option value="minigame">Minigame</option>
                                <option value="mobs">Mobs</option>
                                <option value="optimisation">Optimisation</option>
                                <option value="social">Social</option>
                                <option value="storage">Storage</option>
                                <option value="technology">Technology</option>
                                <option value="transportation">Transportation</option>
                                <option value="utility">Utility</option>
                                <option value="world-generation">World Generation</option>
                            </optgroup>
                            <optgroup label="Server">
                                <option value="administration">Administration</option>
                                <option value="anti-cheat">Anti-Cheat</option>
                                <option value="chat">Chat</option>
                                <option value="moderation">Moderation</option>
                                <option value="permissions">Permissions</option>
                            </optgroup>
                        </select>
                        <div class="password-help">
                            Choose a single category that best describes your addon
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editYoutube"
                            >YouTube Video URL (optional)</label
                        >
                        <input
                            type="url"
                            id="editYoutube"
                            placeholder="https://youtube.com/watch?v=..."
                        />
                        <div class="password-help">
                            Showcase video for your addon
                        </div>
                    </div>

                    <!-- Ko-fi Support Link Section -->
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="editKofiCheckbox" />
                            <label for="editKofiCheckbox"
                                >Enable Ko-fi Support Link</label
                            >
                        </div>
                        <div id="editKofiGroup" style="display: none">
                            <label for="editKofiUrl">Ko-fi URL</label>
                            <input
                                type="url"
                                id="editKofiUrl"
                                placeholder="https://ko-fi.com/yourusername"
                            />
                            <div class="password-help">
                                Allow users to support you via Ko-fi. Format:
                                https://ko-fi.com/username
                            </div>
                        </div>
                    </div>

                    <div
                        id="editProgress"
                        class="upload-progress"
                        style="display: none"
                    >
                        <div class="progress-bar">
                            <div
                                class="progress-fill"
                                id="editProgressFill"
                            ></div>
                        </div>
                        <span id="editProgressText">Updating...</span>
                    </div>

                    <button type="submit" class="form-btn" id="editBtn">
                        Save Changes
                    </button>

                    <!-- Danger Zone -->
                    <div class="danger-zone">
                        <h4>Danger Zone</h4>
                        <p>
                            Deleting a package is permanent and cannot be
                            undone.
                        </p>
                        <button
                            type="button"
                            class="delete-btn"
                            style="width: 100%"
                            onclick="handleDeletePackage()"
                        >
                            Delete Package
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <script>
            const API_URL = "";
            let allPackages = [];
            let filteredPackages = [];
            let currentPage = 1;
            let pageSize = 20;
            let sortBy = "newest";
            let authorCache = {};
            let authToken = null;
            let currentUsername = null;
            let currentUserId = null;

            // Turnstile tokens
            let loginTurnstileToken = null;
            let registerTurnstileToken = null;

            // Dev mode flag (fetched from server)
            let devMode = false;

            // Fetch config from server to check dev mode
            async function fetchConfig() {
                try {
                    const response = await fetch(`${API_URL}/api/config`);
                    if (response.ok) {
                        const config = await response.json();
                        devMode = config.devMode || false;
                        if (devMode) {
                            console.log("Dev mode enabled - CAPTCHA bypassed");
                            // Hide turnstile widgets in dev mode
                            document
                                .querySelectorAll(".cf-turnstile")
                                .forEach((el) => {
                                    el.style.display = "none";
                                });
                        }
                    }
                } catch (e) {
                    console.error("Failed to fetch config:", e);
                }
            }

            // Turnstile callbacks
            function onLoginTurnstileSuccess(token) {
                loginTurnstileToken = token;
            }

            function onLoginTurnstileExpired() {
                loginTurnstileToken = null;
            }

            function onRegisterTurnstileSuccess(token) {
                registerTurnstileToken = token;
            }

            function onRegisterTurnstileExpired() {
                registerTurnstileToken = null;
            }

            window.addEventListener("DOMContentLoaded", async () => {
                await fetchConfig();
                loadPackages();
                setupEventListeners();
                checkAuthStatus();
                handleEditHash();
            });

            window.addEventListener("hashchange", handleEditHash);

            async function checkAuthStatus() {
                const savedToken = localStorage.getItem("authToken");
                const savedUsername = localStorage.getItem("username");

                if (savedToken && savedUsername) {
                    authToken = savedToken;
                    currentUsername = savedUsername;

                    // Fetch user ID for ownership checks
                    try {
                        const response = await fetch(
                            `${API_URL}/user/${savedUsername}`,
                        );
                        if (response.ok) {
                            const userData = await response.json();
                            currentUserId = userData.id;
                            localStorage.setItem("userId", currentUserId);
                        }
                    } catch (e) {
                        // Try to get from localStorage as fallback
                        const savedUserId = localStorage.getItem("userId");
                        if (savedUserId) {
                            currentUserId = parseInt(savedUserId);
                        }
                    }

                    updateProfileUI();
                }
            }

            function updateProfileUI() {
                const headerRight = document.getElementById("headerRight");
                if (authToken && currentUsername) {
                    headerRight.innerHTML = `
            <div class="profile-user-info">
              <span>Logged in as: <strong>${escapeHtml(currentUsername)}</strong></span>
              <button class="upload-btn" onclick="openUploadModal()">Upload Addon</button>
              <button class="profile-btn" onclick="openProfileModal()">Profile</button>
            </div>
          `;
                } else {
                    headerRight.innerHTML = `<button class="profile-btn" onclick="openProfileModal()">Profile</button>`;
                }
            }

            function openProfileModal() {
                const modal = document.getElementById("profileModal");
                modal.style.display = "block";

                if (authToken && currentUsername) {
                    document.getElementById("authContainer").style.display =
                        "none";
                    document.getElementById("profileContainer").style.display =
                        "block";
                    document.getElementById("loggedUsername").textContent =
                        currentUsername;
                } else {
                    document.getElementById("authContainer").style.display =
                        "block";
                    document.getElementById("profileContainer").style.display =
                        "none";
                    switchTab("login");
                }
            }

            function closeProfileModal() {
                const modal = document.getElementById("profileModal");
                modal.style.display = "none";
            }

            window.onclick = function (event) {
                const modal = document.getElementById("profileModal");
                if (event.target === modal) {
                    modal.style.display = "none";
                }
            };

            function switchTab(tabName) {
                // Hide all tab content and remove active class from buttons
                document.querySelectorAll(".tab-content").forEach((tab) => {
                    tab.classList.remove("active");
                });
                document.querySelectorAll(".tab-btn").forEach((btn) => {
                    btn.classList.remove("active");
                });

                // Show selected tab and mark button as active
                const selectedTab = document.getElementById(tabName);
                if (selectedTab) {
                    selectedTab.classList.add("active");
                }

                const selectedBtn = document.querySelector(
                    `[data-tab="${tabName}"]`,
                );
                if (selectedBtn) {
                    selectedBtn.classList.add("active");
                }

                // Clear error messages
                document.getElementById("loginError").style.display = "none";
                document.getElementById("registerError").style.display = "none";
                document.getElementById("registerSuccess").style.display =
                    "none";
            }

            async function handleLogin(event) {
                event.preventDefault();

                const username = document.getElementById("loginUsername").value;
                const password = document.getElementById("loginPassword").value;
                const loginBtn = document.getElementById("loginBtn");
                const errorDiv = document.getElementById("loginError");

                errorDiv.style.display = "none";

                // Check Turnstile token (skip in dev mode)
                if (!devMode && !loginTurnstileToken) {
                    errorDiv.textContent =
                        "Please complete the CAPTCHA verification";
                    errorDiv.style.display = "block";
                    return;
                }

                loginBtn.disabled = true;
                loginBtn.textContent = "Logging in...";

                try {
                    const response = await fetch(`${API_URL}/auth/login`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            username,
                            password,
                            turnstileToken: devMode
                                ? "dev-mode"
                                : loginTurnstileToken,
                        }),
                    });

                    const data = await response.json();
                    console.log("Login response:", data);

                    if (!response.ok || !data.success) {
                        throw new Error(data.error || "Login failed");
                    }

                    authToken = data.token;
                    currentUsername = data.user.username;
                    currentUserId = data.user.id;

                    console.log("Setting auth:", {
                        authToken,
                        currentUsername,
                        currentUserId,
                    });
                    localStorage.setItem("authToken", authToken);
                    localStorage.setItem("username", currentUsername);
                    localStorage.setItem("userId", currentUserId);
                    console.log("Stored in localStorage:", {
                        authToken: localStorage.getItem("authToken"),
                        username: localStorage.getItem("username"),
                        userId: localStorage.getItem("userId"),
                    });

                    updateProfileUI();
                    closeProfileModal();

                    // Clear form
                    document.getElementById("loginUsername").value = "";
                    document.getElementById("loginPassword").value = "";
                } catch (error) {
                    console.error("Login error:", error);
                    errorDiv.textContent = error.message;
                    errorDiv.style.display = "block";
                    // Reset Turnstile on error
                    loginTurnstileToken = null;
                    if (typeof turnstile !== "undefined") {
                        turnstile.reset(
                            document.querySelector("#loginTurnstile"),
                        );
                    }
                } finally {
                    loginBtn.disabled = false;
                    loginBtn.textContent = "Login";
                }
            }

            async function handleRegister(event) {
                event.preventDefault();

                const username =
                    document.getElementById("registerUsername").value;
                const email = document.getElementById("registerEmail").value;
                const password =
                    document.getElementById("registerPassword").value;
                const registerBtn = document.getElementById("registerBtn");
                const errorDiv = document.getElementById("registerError");
                const successDiv = document.getElementById("registerSuccess");

                errorDiv.style.display = "none";
                successDiv.style.display = "none";

                // Check Turnstile token (skip in dev mode)
                if (!devMode && !registerTurnstileToken) {
                    errorDiv.textContent =
                        "Please complete the CAPTCHA verification";
                    errorDiv.style.display = "block";
                    return;
                }

                registerBtn.disabled = true;
                registerBtn.textContent = "Registering...";

                try {
                    const response = await fetch(`${API_URL}/auth/register`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            username,
                            email,
                            password,
                            turnstileToken: devMode
                                ? "dev-mode"
                                : registerTurnstileToken,
                        }),
                    });

                    const data = await response.json();

                    if (!response.ok || !data.success) {
                        const errorMsg = data.details
                            ? Array.isArray(data.details)
                                ? data.details.join(", ")
                                : data.details
                            : data.error;
                        throw new Error(errorMsg || "Registration failed");
                    }

                    successDiv.textContent =
                        "Registration successful! You can now login.";
                    successDiv.style.display = "block";

                    // Clear form
                    document.getElementById("registerUsername").value = "";
                    document.getElementById("registerEmail").value = "";
                    document.getElementById("registerPassword").value = "";

                    // Switch to login tab after 2 seconds
                    setTimeout(() => {
                        document.querySelector(".tab-btn").click();
                    }, 2000);
                } catch (error) {
                    errorDiv.textContent = error.message;
                    errorDiv.style.display = "block";
                    // Reset Turnstile on error
                    registerTurnstileToken = null;
                    if (typeof turnstile !== "undefined") {
                        turnstile.reset(
                            document.querySelector("#registerTurnstile"),
                        );
                    }
                } finally {
                    registerBtn.disabled = false;
                    registerBtn.textContent = "Register";
                }
            }

            function handleLogout() {
                authToken = null;
                currentUsername = null;
                currentUserId = null;
                localStorage.removeItem("authToken");
                localStorage.removeItem("username");
                localStorage.removeItem("userId");

                updateProfileUI();
                closeProfileModal();

                // Re-render packages to remove edit buttons
                renderPackages();
            }

            // Upload Modal Functions
            const MAX_FILE_SIZE = 200 * 1024 * 1024; // 200MB

            // Upload form persistence keys
            const UPLOAD_FORM_STORAGE_KEY = "bedpak_upload_form_draft";

            function saveUploadFormData() {
                const formData = {
                    name: document.getElementById("uploadName").value,
                    description: document.getElementById("uploadDescription").value,
                    longDescription: document.getElementById("uploadLongDescription").value,
                    version: document.getElementById("uploadVersion").value,
                    category: document.getElementById("uploadCategory").value,
                    youtubeUrl: document.getElementById("uploadYoutube").value,
                    kofiChecked: document.getElementById("uploadKofiCheckbox").checked,
                    kofiUrl: document.getElementById("uploadKofiUrl").value,
                };
                sessionStorage.setItem(UPLOAD_FORM_STORAGE_KEY, JSON.stringify(formData));
            }

            function restoreUploadFormData() {
                const savedData = sessionStorage.getItem(UPLOAD_FORM_STORAGE_KEY);
                if (!savedData) return false;

                try {
                    const formData = JSON.parse(savedData);
                    document.getElementById("uploadName").value = formData.name || "";
                    document.getElementById("uploadDescription").value = formData.description || "";
                    document.getElementById("uploadLongDescription").value = formData.longDescription || "";
                    document.getElementById("uploadVersion").value = formData.version || "";
                    document.getElementById("uploadCategory").value = formData.category || "";
                    document.getElementById("uploadYoutube").value = formData.youtubeUrl || "";
                    
                    // Restore Ko-fi checkbox and URL
                    const kofiCheckbox = document.getElementById("uploadKofiCheckbox");
                    kofiCheckbox.checked = formData.kofiChecked || false;
                    document.getElementById("uploadKofiGroup").style.display = 
                        formData.kofiChecked ? "block" : "none";
                    document.getElementById("uploadKofiUrl").value = formData.kofiUrl || "";
                    
                    return true;
                } catch (e) {
                    console.error("Failed to restore upload form data:", e);
                    return false;
                }
            }

            function clearUploadFormData() {
                sessionStorage.removeItem(UPLOAD_FORM_STORAGE_KEY);
            }

            function openUploadModal() {
                if (!authToken) {
                    openProfileModal();
                    return;
                }
                const modal = document.getElementById("uploadModal");
                modal.style.display = "block";
                
                // Try to restore saved form data, otherwise reset
                if (!restoreUploadFormData()) {
                    resetUploadForm();
                } else {
                    // Even when restoring, we need to reset UI state elements
                    document.getElementById("uploadError").style.display = "none";
                    document.getElementById("uploadSuccess").style.display = "none";
                    document.getElementById("uploadProgress").style.display = "none";
                    document.getElementById("uploadBtn").disabled = false;
                    document.getElementById("uploadBtn").textContent = "Upload Addon";
                    // File inputs can't be restored for security reasons, so reset their display
                    document.getElementById("selectedFileName").textContent = "No file selected";
                    document.getElementById("selectedFileName").classList.remove("has-file");
                    document.getElementById("selectedIconName").textContent = "No icon selected";
                    document.getElementById("selectedIconName").classList.remove("has-file");
                    document.getElementById("iconPreviewContainer").style.display = "none";
                }
            }

            function closeUploadModal() {
                const modal = document.getElementById("uploadModal");
                modal.style.display = "none";
                // Save form data before closing so user doesn't lose their input
                saveUploadFormData();
            }

            function resetUploadForm() {
                document.getElementById("uploadForm").reset();
                document.getElementById("uploadError").style.display = "none";
                document.getElementById("uploadSuccess").style.display = "none";
                document.getElementById("uploadProgress").style.display =
                    "none";
                document.getElementById("selectedFileName").textContent =
                    "No file selected";
                document
                    .getElementById("selectedFileName")
                    .classList.remove("has-file");
                document.getElementById("selectedIconName").textContent =
                    "No icon selected";
                document
                    .getElementById("selectedIconName")
                    .classList.remove("has-file");
                document.getElementById("iconPreviewContainer").style.display =
                    "none";
                document.getElementById("uploadBtn").disabled = false;
                document.getElementById("uploadBtn").textContent =
                    "Upload Addon";
                // Reset Ko-fi fields
                document.getElementById("uploadKofiCheckbox").checked = false;
                document.getElementById("uploadKofiGroup").style.display =
                    "none";
                document.getElementById("uploadKofiUrl").value = "";
                // Reset long description
                document.getElementById("uploadLongDescription").value = "";
                // Reset category and youtube
                document.getElementById("uploadCategory").value = "";
                document.getElementById("uploadYoutube").value = "";
            }

            // Handle file selection display
            document.addEventListener("DOMContentLoaded", function () {
                const fileInput = document.getElementById("uploadFile");
                if (fileInput) {
                    fileInput.addEventListener("change", function () {
                        const fileName =
                            document.getElementById("selectedFileName");
                        if (this.files && this.files.length > 0) {
                            const file = this.files[0];
                            fileName.textContent = file.name;
                            fileName.classList.add("has-file");

                            // Validate file immediately on selection
                            const validation = validateFile(file);
                            if (!validation.valid) {
                                showUploadError(validation.error);
                                this.value = "";
                                fileName.textContent = "No file selected";
                                fileName.classList.remove("has-file");
                            }
                        } else {
                            fileName.textContent = "No file selected";
                            fileName.classList.remove("has-file");
                        }
                    });
                }

                // Handle icon file selection
                const iconInput = document.getElementById("uploadIcon");
                if (iconInput) {
                    iconInput.addEventListener("change", function () {
                        const iconName =
                            document.getElementById("selectedIconName");
                        const previewContainer = document.getElementById(
                            "iconPreviewContainer",
                        );
                        const preview = document.getElementById("iconPreview");

                        if (this.files && this.files.length > 0) {
                            const file = this.files[0];

                            // Validate icon
                            const validation = validateIcon(file);
                            if (!validation.valid) {
                                showUploadError(validation.error);
                                this.value = "";
                                iconName.textContent = "No icon selected";
                                iconName.classList.remove("has-file");
                                previewContainer.style.display = "none";
                                return;
                            }

                            iconName.textContent = file.name;
                            iconName.classList.add("has-file");

                            // Show preview
                            const reader = new FileReader();
                            reader.onload = function (e) {
                                preview.src = e.target.result;
                                previewContainer.style.display = "block";
                            };
                            reader.readAsDataURL(file);
                        } else {
                            iconName.textContent = "No icon selected";
                            iconName.classList.remove("has-file");
                            previewContainer.style.display = "none";
                        }
                    });
                }

                // Upload modal: toggle Ko-fi URL section
                const uploadKofiCheckbox =
                    document.getElementById("uploadKofiCheckbox");
                if (uploadKofiCheckbox) {
                    uploadKofiCheckbox.addEventListener("change", function () {
                        document.getElementById(
                            "uploadKofiGroup",
                        ).style.display = this.checked ? "block" : "none";
                        if (!this.checked) {
                            document.getElementById("uploadKofiUrl").value = "";
                        }
                    });
                }

                // Edit modal: toggle icon/file update sections
                const updateIconCheckbox =
                    document.getElementById("updateIconCheckbox");
                if (updateIconCheckbox) {
                    updateIconCheckbox.addEventListener("change", function () {
                        document.getElementById("editIconGroup").style.display =
                            this.checked ? "block" : "none";
                        if (!this.checked) {
                            document.getElementById("editIcon").value = "";
                            document.getElementById(
                                "editSelectedIconName",
                            ).textContent = "No icon selected";
                            document
                                .getElementById("editSelectedIconName")
                                .classList.remove("has-file");
                            document.getElementById(
                                "editIconPreviewContainer",
                            ).style.display = "none";
                        }
                    });
                }

                const updateFileCheckbox =
                    document.getElementById("updateFileCheckbox");
                if (updateFileCheckbox) {
                    updateFileCheckbox.addEventListener("change", function () {
                        document.getElementById("editFileGroup").style.display =
                            this.checked ? "block" : "none";
                        if (!this.checked) {
                            document.getElementById("editFile").value = "";
                            document.getElementById(
                                "editSelectedFileName",
                            ).textContent = "No file selected";
                            document
                                .getElementById("editSelectedFileName")
                                .classList.remove("has-file");
                        }
                    });
                }

                // Edit modal: handle icon file selection
                const editIconInput = document.getElementById("editIcon");
                if (editIconInput) {
                    editIconInput.addEventListener("change", function () {
                        const editIconName = document.getElementById(
                            "editSelectedIconName",
                        );
                        const editPreviewContainer = document.getElementById(
                            "editIconPreviewContainer",
                        );
                        const editPreview =
                            document.getElementById("editIconPreview");

                        if (this.files && this.files.length > 0) {
                            const file = this.files[0];

                            // Validate icon
                            const validation = validateIcon(file);
                            if (!validation.valid) {
                                showEditError(validation.error);
                                this.value = "";
                                editIconName.textContent = "No icon selected";
                                editIconName.classList.remove("has-file");
                                editPreviewContainer.style.display = "none";
                                return;
                            }

                            editIconName.textContent = file.name;
                            editIconName.classList.add("has-file");

                            // Show preview
                            const reader = new FileReader();
                            reader.onload = function (e) {
                                editPreview.src = e.target.result;
                                editPreviewContainer.style.display = "block";
                            };
                            reader.readAsDataURL(file);
                        } else {
                            editIconName.textContent = "No icon selected";
                            editIconName.classList.remove("has-file");
                            editPreviewContainer.style.display = "none";
                        }
                    });
                }

                // Edit modal: handle addon file selection
                const editFileInput = document.getElementById("editFile");
                if (editFileInput) {
                    editFileInput.addEventListener("change", function () {
                        const editFileName = document.getElementById(
                            "editSelectedFileName",
                        );
                        if (this.files && this.files.length > 0) {
                            const file = this.files[0];

                            // Validate file
                            const validation = validateFile(file);
                            if (!validation.valid) {
                                showEditError(validation.error);
                                this.value = "";
                                editFileName.textContent = "No file selected";
                                editFileName.classList.remove("has-file");
                                return;
                            }

                            editFileName.textContent = file.name;
                            editFileName.classList.add("has-file");
                        } else {
                            editFileName.textContent = "No file selected";
                            editFileName.classList.remove("has-file");
                        }
                    });
                }

                // Edit modal: toggle Ko-fi URL section
                const editKofiCheckbox =
                    document.getElementById("editKofiCheckbox");
                if (editKofiCheckbox) {
                    editKofiCheckbox.addEventListener("change", function () {
                        document.getElementById("editKofiGroup").style.display =
                            this.checked ? "block" : "none";
                        if (!this.checked) {
                            document.getElementById("editKofiUrl").value = "";
                        }
                    });
                }
            });

            const MAX_ICON_SIZE = 2 * 1024 * 1024; // 2MB

            function validateIcon(file) {
                // Check file size
                if (file.size > MAX_ICON_SIZE) {
                    return {
                        valid: false,
                        error: `Icon too large. Maximum size is ${MAX_ICON_SIZE / (1024 * 1024)}MB`,
                    };
                }

                // Check file type
                const validTypes = [
                    "image/png",
                    "image/jpeg",
                    "image/webp",
                    "image/gif",
                    "image/svg+xml",
                ];
                // Also check extension for SVG (some browsers report different mime types)
                const isSvg = file.name.toLowerCase().endsWith(".svg");
                if (!validTypes.includes(file.type) && !isSvg) {
                    return {
                        valid: false,
                        error: "Invalid icon type. Only PNG, JPG, WebP, GIF, and SVG are accepted.",
                    };
                }

                return { valid: true };
            }

            function validateFile(file) {
                // Check file size
                if (file.size > MAX_FILE_SIZE) {
                    return {
                        valid: false,
                        error: `File too large. Maximum size is ${MAX_FILE_SIZE / (1024 * 1024)}MB`,
                    };
                }

                // Check file extension
                if (!file.name.toLowerCase().endsWith(".mcaddon")) {
                    return {
                        valid: false,
                        error: "Invalid file type. Only .mcaddon files are accepted.",
                    };
                }

                return { valid: true };
            }

            function showUploadError(message) {
                const errorDiv = document.getElementById("uploadError");
                errorDiv.textContent = message;
                errorDiv.style.display = "block";
                document.getElementById("uploadSuccess").style.display = "none";
            }

            function showUploadSuccess(message) {
                const successDiv = document.getElementById("uploadSuccess");
                successDiv.textContent = message;
                successDiv.style.display = "block";
                document.getElementById("uploadError").style.display = "none";
            }

            async function handleUpload(event) {
                event.preventDefault();

                const name = document.getElementById("uploadName").value.trim();
                const description = document
                    .getElementById("uploadDescription")
                    .value.trim();
                const longDescription = document
                    .getElementById("uploadLongDescription")
                    .value.trim();
                const version =
                    document.getElementById("uploadVersion").value.trim() ||
                    "1.0.0";
                const fileInput = document.getElementById("uploadFile");
                const iconInput = document.getElementById("uploadIcon");
                const uploadBtn = document.getElementById("uploadBtn");
                const progressDiv = document.getElementById("uploadProgress");
                const progressFill = document.getElementById("progressFill");
                const progressText = document.getElementById("progressText");
                const kofiCheckbox =
                    document.getElementById("uploadKofiCheckbox");
                const kofiUrl = kofiCheckbox.checked
                    ? document.getElementById("uploadKofiUrl").value.trim()
                    : "";
                // Category and YouTube
                const category = document.getElementById("uploadCategory").value;
                const youtubeUrl = document
                    .getElementById("uploadYoutube")
                    .value.trim();

                // Reset messages
                document.getElementById("uploadError").style.display = "none";
                document.getElementById("uploadSuccess").style.display = "none";

                // Validate name format
                const nameRegex = /^[a-zA-Z0-9_-]{1,64}$/;
                if (!nameRegex.test(name)) {
                    showUploadError(
                        "Invalid package name. Use only letters, numbers, underscores, and hyphens (1-64 chars).",
                    );
                    return;
                }

                // Validate version format
                const versionRegex = /^\d+\.\d+\.\d+$/;
                if (version && !versionRegex.test(version)) {
                    showUploadError(
                        "Invalid version format. Use X.Y.Z (e.g., 1.0.0).",
                    );
                    return;
                }

                // Validate Ko-fi URL format if provided
                if (kofiUrl) {
                    const kofiUrlRegex =
                        /^https?:\/\/(www\.)?ko-fi\.com\/[a-zA-Z0-9_]+\/?$/;
                    if (!kofiUrlRegex.test(kofiUrl)) {
                        showUploadError(
                            "Invalid Ko-fi URL. Use format: https://ko-fi.com/username",
                        );
                        return;
                    }
                }

                // Validate YouTube URL format if provided
                if (youtubeUrl) {
                    const youtubeUrlRegex =
                        /^https?:\/\/(www\.)?(youtube\.com\/watch\?v=|youtu\.be\/)[a-zA-Z0-9_-]+/;
                    if (!youtubeUrlRegex.test(youtubeUrl)) {
                        showUploadError(
                            "Invalid YouTube URL. Use a valid YouTube video URL.",
                        );
                        return;
                    }
                }

                // Validate icon if provided
                if (iconInput.files && iconInput.files.length > 0) {
                    const iconValidation = validateIcon(iconInput.files[0]);
                    if (!iconValidation.valid) {
                        showUploadError(iconValidation.error);
                        return;
                    }
                }

                // Validate file
                if (!fileInput.files || fileInput.files.length === 0) {
                    showUploadError("Please select a .mcaddon file.");
                    return;
                }

                const file = fileInput.files[0];
                const fileValidation = validateFile(file);
                if (!fileValidation.valid) {
                    showUploadError(fileValidation.error);
                    return;
                }

                // Disable button and show progress
                uploadBtn.disabled = true;
                uploadBtn.textContent = "Uploading...";
                progressDiv.style.display = "block";
                progressFill.style.width = "0%";
                progressText.textContent = "Reading file...";

                try {
                    // Read file as base64
                    progressText.textContent = "Encoding addon file...";
                    progressFill.style.width = "15%";

                    const fileBase64 = await readFileAsBase64(file);

                    // Read icon as base64 if provided
                    let iconBase64 = null;
                    if (iconInput.files && iconInput.files.length > 0) {
                        progressText.textContent = "Encoding icon...";
                        progressFill.style.width = "30%";
                        iconBase64 = await readFileAsBase64(iconInput.files[0]);
                    }

                    progressText.textContent = "Uploading to server...";
                    progressFill.style.width = "50%";

                    // Send upload request
                    const requestBody = {
                        name,
                        description,
                        version,
                        fileBase64,
                    };

                    // Only include icon if provided
                    if (iconBase64) {
                        requestBody.iconBase64 = iconBase64;
                    }

                    // Only include Ko-fi URL if provided
                    if (kofiUrl) {
                        requestBody.kofiUrl = kofiUrl;
                    }

                    // Only include long description if provided
                    if (longDescription) {
                        requestBody.longDescription = longDescription;
                    }

                    // Only include category if provided
                    if (category) {
                        requestBody.category = category;
                    }

                    // Only include YouTube URL if provided
                    if (youtubeUrl) {
                        requestBody.youtubeUrl = youtubeUrl;
                    }

                    const response = await fetch(`${API_URL}/packages`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${authToken}`,
                        },
                        body: JSON.stringify(requestBody),
                    });

                    progressFill.style.width = "90%";

                    const data = await response.json();

                    if (!response.ok || !data.success) {
                        throw new Error(data.error || "Upload failed");
                    }

                    progressFill.style.width = "100%";
                    progressText.textContent = "Complete!";

                    showUploadSuccess(
                        "Addon uploaded successfully! Refreshing packages...",
                    );

                    // Clear saved form data on successful upload
                    clearUploadFormData();

                    // Refresh packages list after short delay
                    setTimeout(async () => {
                        await loadPackages();
                        // Reset form after successful upload (don't just close, actually clear it)
                        resetUploadForm();
                        document.getElementById("uploadModal").style.display = "none";
                    }, 1500);
                } catch (error) {
                    console.error("Upload error:", error);
                    showUploadError(
                        error.message ||
                            "Failed to upload addon. Please try again.",
                    );
                    progressDiv.style.display = "none";
                } finally {
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = "Upload Addon";
                }
            }

            function readFileAsBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();

                    reader.onload = () => {
                        // Result is a data URL like "data:application/octet-stream;base64,..."
                        // We need just the base64 part
                        const result = reader.result;
                        if (typeof result === "string") {
                            const base64 = result.split(",")[1];
                            resolve(base64);
                        } else {
                            reject(new Error("Failed to read file"));
                        }
                    };

                    reader.onerror = () => {
                        reject(new Error("Failed to read file"));
                    };

                    reader.readAsDataURL(file);
                });
            }

            // Close modals when clicking outside
            window.addEventListener("click", function (event) {
                const uploadModal = document.getElementById("uploadModal");
                if (event.target === uploadModal) {
                    closeUploadModal();
                }
                const editModal = document.getElementById("editModal");
                if (event.target === editModal) {
                    closeEditModal();
                }
            });

            // Edit Modal Functions
            function openEditModal(
                packageId,
                name,
                description,
                version,
                iconUrl,
                kofiUrl,
                longDescription,
                categorySlug,
                youtubeUrl,
            ) {
                if (!authToken) {
                    openProfileModal();
                    return;
                }

                const modal = document.getElementById("editModal");
                modal.style.display = "block";

                // Populate form fields
                document.getElementById("editPackageId").value = packageId;
                document.getElementById("editPackageOriginalName").value = name;
                document.getElementById("editName").value = name;
                document.getElementById("editDescription").value = description;
                document.getElementById("editVersion").value = version;

                // Decode escaped newlines back to actual newlines for the textarea
                const decodedLongDesc = longDescription
                    ? longDescription.replace(/\\n/g, "\n")
                    : "";
                document.getElementById("editLongDescription").value =
                    decodedLongDesc;

                // Show current icon if exists
                const currentIconContainer = document.getElementById(
                    "currentIconContainer",
                );
                const currentIconPreview =
                    document.getElementById("currentIconPreview");
                if (iconUrl) {
                    currentIconPreview.src = iconUrl;
                    currentIconContainer.style.display = "block";
                } else {
                    currentIconContainer.style.display = "none";
                }

                // Reset checkboxes and file inputs
                document.getElementById("updateIconCheckbox").checked = false;
                document.getElementById("updateFileCheckbox").checked = false;
                document.getElementById("editIconGroup").style.display = "none";
                document.getElementById("editFileGroup").style.display = "none";
                document.getElementById("editIcon").value = "";
                document.getElementById("editFile").value = "";
                document.getElementById("editSelectedIconName").textContent =
                    "No icon selected";
                document
                    .getElementById("editSelectedIconName")
                    .classList.remove("has-file");
                document.getElementById("editSelectedFileName").textContent =
                    "No file selected";
                document
                    .getElementById("editSelectedFileName")
                    .classList.remove("has-file");
                document.getElementById(
                    "editIconPreviewContainer",
                ).style.display = "none";

                // Handle Ko-fi URL
                const editKofiCheckbox =
                    document.getElementById("editKofiCheckbox");
                const editKofiGroup = document.getElementById("editKofiGroup");
                const editKofiUrlEl = document.getElementById("editKofiUrl");
                if (kofiUrl) {
                    editKofiCheckbox.checked = true;
                    editKofiGroup.style.display = "block";
                    editKofiUrlEl.value = kofiUrl;
                } else {
                    editKofiCheckbox.checked = false;
                    editKofiGroup.style.display = "none";
                    editKofiUrlEl.value = "";
                }

                // Handle category
                document.getElementById("editCategory").value = categorySlug || "";
                document.getElementById("editYoutube").value = youtubeUrl || "";

                // Reset messages
                document.getElementById("editError").style.display = "none";
                document.getElementById("editSuccess").style.display = "none";
                document.getElementById("editProgress").style.display = "none";
                document.getElementById("editBtn").disabled = false;
                document.getElementById("editBtn").textContent = "Save Changes";
            }

            function closeEditModal() {
                const modal = document.getElementById("editModal");
                modal.style.display = "none";
            }

            async function handleEditHash() {
                const hash = window.location.hash;
                if (!hash || !hash.startsWith('#edit-')) {
                    return;
                }
                
                const packageName = decodeURIComponent(hash.substring(6)); // Remove '#edit-'
                if (!packageName) {
                    return;
                }
                
                try {
                    const response = await fetch(`${API_URL}/packages/${encodeURIComponent(packageName)}/full`);
                    if (!response.ok) {
                        if (response.status === 404) {
                            console.error('Package not found:', packageName);
                        } else {
                            console.error('Failed to fetch package:', response.status);
                        }
                        return;
                    }
                    
                    const result = await response.json();
                    if (!result.success || !result.data) {
                        console.error('Invalid package data:', result);
                        return;
                    }
                    
                    const pkg = result.data;
                    openEditModal(
                        pkg.id,
                        pkg.name,
                        pkg.description,
                        pkg.version,
                        pkg.icon_url,
                        pkg.kofi_url,
                        pkg.long_description,
                        pkg.category ? pkg.category.slug : null,
                        pkg.youtube_url
                    );
                } catch (error) {
                    console.error('Error fetching package for edit:', error);
                }
            }

            function showEditError(message) {
                const errorDiv = document.getElementById("editError");
                errorDiv.textContent = message;
                errorDiv.style.display = "block";
                document.getElementById("editSuccess").style.display = "none";
            }

            function showEditSuccess(message) {
                const successDiv = document.getElementById("editSuccess");
                successDiv.textContent = message;
                successDiv.style.display = "block";
                document.getElementById("editError").style.display = "none";
            }

            async function handleUpdatePackage(event) {
                event.preventDefault();

                const packageId =
                    document.getElementById("editPackageId").value;
                const name = document.getElementById("editName").value.trim();
                const description = document
                    .getElementById("editDescription")
                    .value.trim();
                const longDescription = document
                    .getElementById("editLongDescription")
                    .value.trim();
                const version =
                    document.getElementById("editVersion").value.trim() ||
                    "1.0.0";
                const updateIcon =
                    document.getElementById("updateIconCheckbox").checked;
                const updateFile =
                    document.getElementById("updateFileCheckbox").checked;
                const iconInput = document.getElementById("editIcon");
                const fileInput = document.getElementById("editFile");
                const editBtn = document.getElementById("editBtn");
                const progressDiv = document.getElementById("editProgress");
                const progressFill =
                    document.getElementById("editProgressFill");
                const progressText =
                    document.getElementById("editProgressText");
                const kofiCheckbox =
                    document.getElementById("editKofiCheckbox");
                const kofiUrl = kofiCheckbox.checked
                    ? document.getElementById("editKofiUrl").value.trim()
                    : null;
                // Category and YouTube
                const category = document.getElementById("editCategory").value;
                const youtubeUrl =
                    document.getElementById("editYoutube").value.trim() || null;

                // Reset messages
                document.getElementById("editError").style.display = "none";
                document.getElementById("editSuccess").style.display = "none";

                // Validate name format
                const nameRegex = /^[a-zA-Z0-9_-]{1,64}$/;
                if (!nameRegex.test(name)) {
                    showEditError(
                        "Invalid package name. Use only letters, numbers, underscores, and hyphens (1-64 chars).",
                    );
                    return;
                }

                // Validate version format
                const versionRegex = /^\d+\.\d+\.\d+$/;
                if (version && !versionRegex.test(version)) {
                    showEditError(
                        "Invalid version format. Use X.Y.Z (e.g., 1.0.0).",
                    );
                    return;
                }

                // Validate Ko-fi URL format if provided
                if (kofiUrl) {
                    const kofiUrlRegex =
                        /^https?:\/\/(www\.)?ko-fi\.com\/[a-zA-Z0-9_]+\/?$/;
                    if (!kofiUrlRegex.test(kofiUrl)) {
                        showEditError(
                            "Invalid Ko-fi URL. Use format: https://ko-fi.com/username",
                        );
                        return;
                    }
                }

                // Validate YouTube URL format if provided
                if (youtubeUrl) {
                    const youtubeUrlRegex =
                        /^https?:\/\/(www\.)?(youtube\.com\/watch\?v=|youtu\.be\/)[a-zA-Z0-9_-]+/;
                    if (!youtubeUrlRegex.test(youtubeUrl)) {
                        showEditError(
                            "Invalid YouTube URL. Use a valid YouTube video URL.",
                        );
                        return;
                    }
                }

                // Validate icon if updating
                if (
                    updateIcon &&
                    iconInput.files &&
                    iconInput.files.length > 0
                ) {
                    const iconValidation = validateIcon(iconInput.files[0]);
                    if (!iconValidation.valid) {
                        showEditError(iconValidation.error);
                        return;
                    }
                }

                // Validate file if updating
                if (
                    updateFile &&
                    fileInput.files &&
                    fileInput.files.length > 0
                ) {
                    const fileValidation = validateFile(fileInput.files[0]);
                    if (!fileValidation.valid) {
                        showEditError(fileValidation.error);
                        return;
                    }
                }

                // Disable button and show progress
                editBtn.disabled = true;
                editBtn.textContent = "Saving...";
                progressDiv.style.display = "block";
                progressFill.style.width = "0%";
                progressText.textContent = "Preparing update...";

                try {
                    // Build the request body
                    const requestBody = {
                        name,
                        description,
                        version,
                        kofiUrl: kofiUrl, // Can be null to remove, or a URL to set
                        longDescription: longDescription || null, // Can be null to remove, or text to set
                        category: category || null, // Can be null to clear, or slug to set
                        youtubeUrl: youtubeUrl, // Can be null to remove
                    };

                    progressFill.style.width = "20%";

                    // Encode icon if updating
                    if (
                        updateIcon &&
                        iconInput.files &&
                        iconInput.files.length > 0
                    ) {
                        progressText.textContent = "Encoding icon...";
                        requestBody.iconBase64 = await readFileAsBase64(
                            iconInput.files[0],
                        );
                    }

                    progressFill.style.width = "40%";

                    // Encode file if updating
                    if (
                        updateFile &&
                        fileInput.files &&
                        fileInput.files.length > 0
                    ) {
                        progressText.textContent = "Encoding addon file...";
                        requestBody.fileBase64 = await readFileAsBase64(
                            fileInput.files[0],
                        );
                    }

                    progressFill.style.width = "60%";
                    progressText.textContent = "Sending update...";

                    const response = await fetch(
                        `${API_URL}/packages/${packageId}`,
                        {
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json",
                                Authorization: `Bearer ${authToken}`,
                            },
                            body: JSON.stringify(requestBody),
                        },
                    );

                    progressFill.style.width = "90%";

                    const data = await response.json();

                    if (!response.ok || !data.success) {
                        throw new Error(data.error || "Update failed");
                    }

                    progressFill.style.width = "100%";
                    progressText.textContent = "Complete!";

                    showEditSuccess(
                        "Package updated successfully! Refreshing...",
                    );

                    // Refresh packages list after short delay
                    setTimeout(async () => {
                        await loadPackages();
                        closeEditModal();
                    }, 1500);
                } catch (error) {
                    console.error("Update error:", error);
                    showEditError(
                        error.message ||
                            "Failed to update package. Please try again.",
                    );
                    progressDiv.style.display = "none";
                } finally {
                    editBtn.disabled = false;
                    editBtn.textContent = "Save Changes";
                }
            }

            async function handleDeletePackage() {
                const packageId =
                    document.getElementById("editPackageId").value;
                const packageName = document.getElementById(
                    "editPackageOriginalName",
                ).value;

                // Confirm deletion
                const confirmed = confirm(
                    `Are you sure you want to delete "${packageName}"? This action cannot be undone.`,
                );
                if (!confirmed) {
                    return;
                }

                // Double confirm for safety
                const doubleConfirm = confirm(
                    `Final confirmation: Delete "${packageName}" permanently?`,
                );
                if (!doubleConfirm) {
                    return;
                }

                try {
                    const response = await fetch(
                        `${API_URL}/packages/${packageId}`,
                        {
                            method: "DELETE",
                            headers: {
                                Authorization: `Bearer ${authToken}`,
                            },
                        },
                    );

                    const data = await response.json();

                    if (!response.ok || !data.success) {
                        throw new Error(data.error || "Delete failed");
                    }

                    showEditSuccess("Package deleted successfully!");

                    // Refresh packages list after short delay
                    setTimeout(async () => {
                        await loadPackages();
                        closeEditModal();
                    }, 1500);
                } catch (error) {
                    console.error("Delete error:", error);
                    showEditError(
                        error.message ||
                            "Failed to delete package. Please try again.",
                    );
                }
            }

            function handleIconError(imgElement) {
                imgElement.style.display = "none";
                const parent = imgElement.parentElement;
                if (!parent.querySelector("span")) {
                    const fallback = document.createElement("span");
                    fallback.style.fontSize = "48px";
                    fallback.style.color = "#555";
                    fallback.textContent = "";
                    parent.appendChild(fallback);
                }
            }

            function setupEventListeners() {
                document
                    .getElementById("search")
                    .addEventListener("input", debounce(applyFilters, 300));
                document
                    .getElementById("author")
                    .addEventListener("input", debounce(applyFilters, 300));
                document
                    .getElementById("categoryFilter")
                    .addEventListener("change", applyFilters);
                document
                    .getElementById("sortBy")
                    .addEventListener("change", applyFilters);

                // Check for category parameter in URL
                const urlParams = new URLSearchParams(window.location.search);
                const categoryParam = urlParams.get("category");
                if (categoryParam) {
                    document.getElementById("categoryFilter").value = categoryParam;
                }
                const authorParam = urlParams.get("author");
                if (authorParam) {
                    document.getElementById("author").value = authorParam;
                }
            }

            function debounce(func, delay) {
                let timeoutId;
                return function (...args) {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => func(...args), delay);
                };
            }

            async function getAuthorName(authorId) {
                if (authorCache[authorId]) {
                    return authorCache[authorId];
                }

                try {
                    const response = await fetch(
                        `${API_URL}/user/id/${authorId}`,
                    );
                    if (response.ok) {
                        const data = await response.json();
                        authorCache[authorId] =
                            data.username || "Author " + authorId;
                    } else {
                        authorCache[authorId] = "Author " + authorId;
                    }
                } catch (e) {
                    authorCache[authorId] = "Author " + authorId;
                }

                return authorCache[authorId];
            }

            async function loadPackages() {
                try {
                    const container =
                        document.getElementById("packagesContainer");
                    container.innerHTML =
                        '<div class="loading"><div class="spinner"></div></div>';

                    let allPackagesList = [];
                    let offset = 0;
                    const limit = 100;

                    while (true) {
                        const response = await fetch(
                            `${API_URL}/packages?limit=${limit}&offset=${offset}`,
                        );

                        if (!response.ok) {
                            throw new Error("Failed to load packages");
                        }

                        const data = await response.json();
                        const packages = data.data || [];

                        if (packages.length === 0) {
                            break;
                        }

                        allPackagesList = allPackagesList.concat(packages);
                        offset += limit;
                    }

                    // Fetch full data with category for each package
                    // We fetch them in batches for better performance
                    const packagesWithCategory = await Promise.all(
                        allPackagesList.map(async (pkg) => {
                            try {
                                const fullResp = await fetch(
                                    `${API_URL}/packages/${encodeURIComponent(pkg.name)}/full`,
                                );
                                if (fullResp.ok) {
                                    const fullData = await fullResp.json();
                                    if (fullData.success && fullData.data) {
                                        return {
                                            ...pkg,
                                            category: fullData.data.category || null,
                                        };
                                    }
                                }
                            } catch (e) {
                                console.error(
                                    "Failed to fetch category for",
                                    pkg.name,
                                );
                            }
                            return { ...pkg, category: null };
                        }),
                    );

                    allPackages = packagesWithCategory;

                    // Pre-load author names for all packages
                    const uniqueAuthorIds = [
                        ...new Set(allPackagesList.map((p) => p.author_id)),
                    ];
                    for (const authorId of uniqueAuthorIds) {
                        await getAuthorName(authorId);
                    }

                    applyFilters();
                } catch (error) {
                    showMessage(
                        "Error loading packages: " + error.message,
                        "error",
                    );
                    document.getElementById("packagesContainer").innerHTML = "";
                }
            }

            async function applyFilters() {
                const searchTerm = document
                    .getElementById("search")
                    .value.toLowerCase();
                const authorTerm = document
                    .getElementById("author")
                    .value.toLowerCase();
                const categoryFilter = document
                    .getElementById("categoryFilter")
                    .value;
                sortBy = document.getElementById("sortBy").value;

                currentPage = 1;

                filteredPackages = allPackages.filter((pkg) => {
                    const matchesSearch =
                        (pkg.name &&
                            pkg.name.toLowerCase().includes(searchTerm)) ||
                        (pkg.description &&
                            pkg.description.toLowerCase().includes(searchTerm));

                    let matchesAuthor = true;
                    if (authorTerm) {
                        const authorName = authorCache[pkg.author_id];
                        matchesAuthor =
                            authorName &&
                            authorName.toLowerCase().includes(authorTerm);
                    }

                    // Check category filter
                    let matchesCategory = true;
                    if (categoryFilter) {
                        matchesCategory = pkg.category && 
                            pkg.category.slug === categoryFilter;
                    }

                    return matchesSearch && matchesAuthor && matchesCategory;
                });

                filteredPackages = sortPackages(filteredPackages, sortBy);

                document.getElementById("totalCount").textContent =
                    filteredPackages.length;

                // Update URL with current filters
                updateURLParams();

                renderPackages();
                renderPagination();
            }

            function updateURLParams() {
                const searchTerm = document
                    .getElementById("search")
                    .value.trim();
                const authorTerm = document
                    .getElementById("author")
                    .value.trim();
                const categoryFilterValue = document
                    .getElementById("categoryFilter")
                    .value;

                const url = new URL(window.location);

                if (categoryFilterValue) {
                    url.searchParams.set("category", categoryFilterValue);
                } else {
                    url.searchParams.delete("category");
                }

                if (authorTerm) {
                    url.searchParams.set("author", authorTerm);
                } else {
                    url.searchParams.delete("author");
                }

                if (searchTerm) {
                    url.searchParams.set("search", searchTerm);
                } else {
                    url.searchParams.delete("search");
                }

                window.history.replaceState({}, "", url);
            }

            function sortPackages(packages, sortType) {
                const sorted = [...packages];

                switch (sortType) {
                    case "oldest":
                        sorted.sort(
                            (a, b) =>
                                new Date(a.created_at) - new Date(b.created_at),
                        );
                        break;
                    case "downloads":
                        sorted.sort(
                            (a, b) => (b.downloads || 0) - (a.downloads || 0),
                        );
                        break;
                    case "name":
                        sorted.sort((a, b) => a.name.localeCompare(b.name));
                        break;
                    case "newest":
                    default:
                        sorted.sort(
                            (a, b) =>
                                new Date(b.created_at) - new Date(a.created_at),
                        );
                        break;
                }

                return sorted;
            }

            async function renderPackages() {
                const container = document.getElementById("packagesContainer");
                const start = (currentPage - 1) * pageSize;
                const end = start + pageSize;
                const paginated = filteredPackages.slice(start, end);

                document.getElementById("displayCount").textContent =
                    paginated.length;

                if (paginated.length === 0) {
                    container.innerHTML = `
          <div class="empty-state">
            <p>No packages found</p>
            <p style="font-size: 12px; color: #555;">Try adjusting your filters</p>
          </div>
        `;
                    return;
                }

                let html = "";
                for (const pkg of paginated) {
                    const authorName = await getAuthorName(pkg.author_id);
                    const iconHtml = pkg.icon_url
                        ? `<img src="${escapeHtml(pkg.icon_url)}" alt="${escapeHtml(pkg.name)} icon" onerror="handleIconError(this)">`
                        : `<span style="font-size: 48px; color: #555;"></span>`;

                    // Check if current user owns this package
                    const isOwner =
                        currentUserId &&
                        Number(pkg.author_id) === Number(currentUserId);

                    // Escape values for use in onclick attribute
                    const escapedName = escapeHtml(pkg.name)
                        .replace(/\\/g, "\\\\")
                        .replace(/'/g, "\\'");
                    const escapedDescription = escapeHtml(pkg.description || "")
                        .replace(/\\/g, "\\\\")
                        .replace(/'/g, "\\'")
                        .replace(/\n/g, "\\n");
                    const escapedVersion = escapeHtml(pkg.version || "1.0.0");
                    const escapedIconUrl = escapeHtml(pkg.icon_url || "")
                        .replace(/\\/g, "\\\\")
                        .replace(/'/g, "\\'");
                    const escapedKofiUrl = escapeHtml(pkg.kofi_url || "")
                        .replace(/\\/g, "\\\\")
                        .replace(/'/g, "\\'");

                    // Download button - if Ko-fi URL exists, show support popup first
                    const downloadUrl = `${API_URL}/packages/${encodeURIComponent(pkg.name)}/download`;
                    const downloadButtonHtml = pkg.kofi_url
                        ? `<button class="download-btn" onclick="showSupportPopup('${downloadUrl}', '${escapedKofiUrl}', '${escapeHtml(authorName).replace(/'/g, "\\'")}')">
                               Download
                             </button>`
                        : `<a href="${downloadUrl}" class="download-btn" download>
                               Download
                             </a>`;

                    // View Details button - link to dedicated package page
                    const viewDetailsBtn = `<a href="/package/${encodeURIComponent(pkg.name)}" class="view-details-btn">View Details</a>`;

                    // Escape long description for onclick
                    const escapedLongDescription = escapeHtml(
                        pkg.long_description || "",
                    )
                        .replace(/\\/g, "\\\\")
                        .replace(/'/g, "\\'")
                        .replace(/\n/g, "\\n");

                    // Prepare category slug for edit modal
                    const categorySlug = pkg.category ? pkg.category.slug : "";
                    const escapedCategorySlug = escapeHtml(categorySlug)
                        .replace(/\\/g, "\\\\")
                        .replace(/'/g, "\\'");
                    const escapedYoutubeUrl = escapeHtml(pkg.youtube_url || "")
                        .replace(/\\/g, "\\\\")
                        .replace(/'/g, "\\'");

                    const actionsHtml = isOwner
                        ? `<div class="package-actions">
                             ${viewDetailsBtn}
                             ${downloadButtonHtml}
                             <button class="edit-btn" onclick="openEditModal(${pkg.id}, '${escapedName}', '${escapedDescription}', '${escapedVersion}', '${escapedIconUrl}', '${escapedKofiUrl}', '${escapedLongDescription}', '${escapedCategorySlug}', '${escapedYoutubeUrl}')">
                               Edit
                             </button>
                           </div>`
                        : `<div class="package-actions">
                             ${viewDetailsBtn}
                             ${downloadButtonHtml}
                           </div>`;

                    // Generate category HTML (single category instead of multiple tags)
                    const categoryHtml = pkg.category
                        ? `<div class="package-category">
                               <a href="/packages.html?category=${encodeURIComponent(pkg.category.slug)}" class="category-badge">${escapeHtml(pkg.category.name)}</a>
                           </div>`
                        : "";

                    html += `
           <div class="package-card">
             <div class="package-icon">
               ${iconHtml}
             </div>
             <h3>${escapeHtml(pkg.name)}</h3>
             <div class="package-meta">
               <span>Downloads: ${pkg.downloads || 0}</span>
               <span>Date: ${formatDate(pkg.created_at)}</span>
             </div>
             ${categoryHtml}
             <p class="package-description">${escapeHtml(pkg.description || "No description provided")}</p>
             <span class="package-version">Version ${pkg.version || "1.0.0"}</span>
             <p class="package-author">By: ${escapeHtml(authorName)}</p>
             ${actionsHtml}
           </div>
         `;
                }
                container.innerHTML = html;
            }

            function renderPagination() {
                const container = document.getElementById("pagination");
                const totalPages = Math.ceil(
                    filteredPackages.length / pageSize,
                );

                if (totalPages <= 1) {
                    container.innerHTML = "";
                    return;
                }

                let html = "";

                html += `<button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? "disabled" : ""}>Previous</button>`;

                const startPage = Math.max(1, currentPage - 2);
                const endPage = Math.min(totalPages, currentPage + 2);

                if (startPage > 1) {
                    html += `<button onclick="goToPage(1)">1</button>`;
                    if (startPage > 2) {
                        html += `<span>...</span>`;
                    }
                }

                for (let i = startPage; i <= endPage; i++) {
                    html += `<button onclick="goToPage(${i})" class="${i === currentPage ? "active" : ""}">${i}</button>`;
                }

                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) {
                        html += `<span>...</span>`;
                    }
                    html += `<button onclick="goToPage(${totalPages})">${totalPages}</button>`;
                }

                html += `<button onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? "disabled" : ""}>Next</button>`;

                container.innerHTML = html;
            }

            function goToPage(page) {
                const totalPages = Math.ceil(
                    filteredPackages.length / pageSize,
                );
                if (page >= 1 && page <= totalPages) {
                    currentPage = page;
                    renderPackages();
                    renderPagination();
                    window.scrollTo({ top: 0, behavior: "smooth" });
                }
            }

            function changePageSize(size) {
                pageSize = size;
                currentPage = 1;

                document.querySelectorAll(".sort-btn").forEach((btn) => {
                    btn.classList.remove("active");
                });
                event.target.classList.add("active");

                renderPackages();
                renderPagination();
            }

            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString("en-US", {
                    year: "numeric",
                    month: "short",
                    day: "numeric",
                });
            }

            function escapeHtml(text) {
                const map = {
                    "&": "&amp;",
                    "<": "&lt;",
                    ">": "&gt;",
                    '"': "&quot;",
                    "'": "&#039;",
                };
                return text.replace(/[&<>"']/g, (m) => map[m]);
            }

            function showMessage(message, type) {
                const container = document.getElementById("messageContainer");
                container.innerHTML = `<div class="${type}">${message}</div>`;
                setTimeout(() => {
                    container.innerHTML = "";
                }, 5000);
            }

            // Support Popup Functions
            let supportPopupTimer = null;
            let pendingDownloadUrl = null;

            function showSupportPopup(downloadUrl, kofiUrl, authorName) {
                pendingDownloadUrl = downloadUrl;

                // Set the author name and Ko-fi link
                document.getElementById("supportAuthorName").textContent =
                    authorName;
                document.getElementById("supportKofiBtn").href = kofiUrl;

                // Reset and show popup
                const popup = document.getElementById("supportPopup");
                const skipBtn = document.getElementById("supportSkipBtn");
                const timerSpan = document.getElementById("supportTimer");

                popup.style.display = "block";
                skipBtn.disabled = true;

                // Start countdown
                let countdown = 3;
                timerSpan.textContent = countdown;

                supportPopupTimer = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        timerSpan.textContent = countdown;
                    } else {
                        clearInterval(supportPopupTimer);
                        supportPopupTimer = null;
                        skipBtn.disabled = false;
                        skipBtn.innerHTML = "No thanks, just download";
                    }
                }, 1000);
            }

            function closeSupportPopup() {
                const popup = document.getElementById("supportPopup");
                popup.style.display = "none";

                if (supportPopupTimer) {
                    clearInterval(supportPopupTimer);
                    supportPopupTimer = null;
                }

                // Reset button state for next time
                const skipBtn = document.getElementById("supportSkipBtn");
                const timerSpan = document.getElementById("supportTimer");
                skipBtn.disabled = true;
                timerSpan.textContent = "3";
                skipBtn.innerHTML =
                    'No thanks, just download (<span class="support-popup-timer" id="supportTimer">3</span>)';
            }

            function skipAndDownload() {
                if (pendingDownloadUrl) {
                    // Trigger download
                    window.location.href = pendingDownloadUrl;
                }
                closeSupportPopup();
            }

            // Close popup when clicking outside
            document
                .getElementById("supportPopup")
                .addEventListener("click", function (event) {
                    if (event.target === this) {
                        // Don't close on outside click - user must choose an option
                    }
                });

            // Skip button click handler
            document
                .getElementById("supportSkipBtn")
                .addEventListener("click", skipAndDownload);

            // Ko-fi button click handler - also close popup and trigger download
            document
                .getElementById("supportKofiBtn")
                .addEventListener("click", function () {
                    // Small delay to let the Ko-fi page open, then trigger download
                    setTimeout(() => {
                        if (pendingDownloadUrl) {
                            window.location.href = pendingDownloadUrl;
                        }
                        closeSupportPopup();
                    }, 500);
                });
        </script>
    </body>
</html>
